<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="sys21_campos_zukarmex.Views.AuthorizationPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:sys21_campos_zukarmex.ViewModels"
             xmlns:apiresponse="clr-namespace:sys21_campos_zukarmex.Models.DTOs.Api"
             x:DataType="viewmodels:AuthorizationViewModel"
             Title="{Binding Title}"
             BackgroundColor="{DynamicResource Gray100}">

    <Grid RowDefinitions="Auto,*">
        <!-- Vale Form -->
        <ScrollView Grid.Row="1" IsVisible="True" Padding="20">
            <StackLayout Spacing="20">

                <!-- Welcome Header -->
                <Frame BackgroundColor="{DynamicResource Primary}" CornerRadius="15"  HasShadow="True">
                    <StackLayout Spacing="10">
                        <Label Text="Uso de Maquinaria" 
                          FontSize="20" 
                          FontAttributes="Bold"
                          TextColor="White"
                         HorizontalOptions="Center"/>
                    </StackLayout>
                </Frame>


                <Frame
              CornerRadius="10"
              HasShadow="True"
              Padding="6"
              Margin="0"
              HorizontalOptions="Fill"
              IsVisible="False">

                    <!-- Triggers que afectan solo al Frame -->
                    <Frame.Triggers>
                        <!-- Cuando es true: -->
                        <DataTrigger TargetType="Frame" Binding="{Binding RequiereAutorizacion}" Value="False">
                            <Setter Property="IsVisible" Value="True" />
                            <Setter Property="BackgroundColor" Value="{StaticResource Success}" />
                        </DataTrigger>

                        <!-- Cuando es false: -->
                        <DataTrigger TargetType="Frame" Binding="{Binding RequiereAutorizacion}" Value="True">
                            <Setter Property="IsVisible" Value="True" />
                            <Setter Property="BackgroundColor" Value="{StaticResource Warning}" />
                        </DataTrigger>
                    </Frame.Triggers>

                    <StackLayout Spacing="0" HorizontalOptions="Center">
                        <!-- Un solo Label; su texto se define por sus propios triggers -->
                        <Label
  x:Name="LblAutorizacion"
  Text=""
  FontSize="15"
  FontAttributes="Bold"
  TextColor="White"
  HorizontalOptions="Center"
  VerticalOptions="Center"
  LineBreakMode="NoWrap"
  Margin="0">

                            <!-- Triggers del Label -->
                            <Label.Triggers>
                                <DataTrigger TargetType="Label" Binding="{Binding RequiereAutorizacion}" Value="False">
                                    <Setter Property="Text" Value="Este vale no requiere autorización." />
                                </DataTrigger>

                                <DataTrigger TargetType="Label" Binding="{Binding RequiereAutorizacion}" Value="True">
                                    <Setter Property="Text" Value="Este vale requiere autorización." />
                                </DataTrigger>
                            </Label.Triggers>
                        </Label>
                    </StackLayout>
                </Frame>

                <Frame Grid.Row="0"
                 BackgroundColor="Orange"
                 Padding="10"
                 CornerRadius="15"
                 IsVisible="{Binding ConnectivitySvc.IsConnected, Converter={StaticResource InvertedBoolConverter}}">
                    <Label Text="No hay conexion, la captura se guardara en local"
                     TextColor="White"
                     FontAttributes="Bold"
                     HorizontalOptions="Center" />
                </Frame>

                <Frame BackgroundColor="White" CornerRadius="15" Padding="20" HasShadow="True">
                    <StackLayout Spacing="15">


                        <!-- Empresa -->
                        <StackLayout>
                            <Label Text="Empresa" FontSize="14" TextColor="{StaticResource Gray600}" />
                            <Frame BackgroundColor="{StaticResource Gray100}" CornerRadius="10" Padding="0" HasShadow="False">
                                <Picker ItemsSource="{Binding Almacenes}"
                              SelectedItem="{Binding SelectedAlmacen}"
                              ItemDisplayBinding="{Binding Nombre}"
                              Title="Seleccione un almacen"
                              FontSize="16"
                              BackgroundColor="Transparent"
                              IsEnabled="{Binding AreFieldsLocked, Converter={StaticResource InvertedBoolConverter}}" />
                            </Frame>
                        </StackLayout>

                        <!-- Fecha -->
                        <StackLayout>
                            <Label Text="Fecha" FontSize="14" TextColor="{StaticResource Gray600}" />
                            <Frame BackgroundColor="{StaticResource Gray100}" CornerRadius="10" Padding="0" HasShadow="False">
                                <DatePicker Date="{Binding Fecha}" 
                            FontSize="16"
                            BackgroundColor="Transparent" 
                            Format="dd/MM/yyyy"
                            IsEnabled="{Binding AreFieldsLocked, Converter={StaticResource InvertedBoolConverter}}" />
                            </Frame>
                        </StackLayout>


                        <!-- Almacen -->
                        <StackLayout>
                            <Label Text="Pluviometro" FontSize="14" TextColor="{StaticResource Gray600}" />
                            <Frame BackgroundColor="{StaticResource Gray100}" CornerRadius="10" Padding="0" HasShadow="False">
                                <Picker ItemsSource="{Binding Almacenes}"
                 SelectedItem="{Binding SelectedAlmacen}"
                 ItemDisplayBinding="{Binding Nombre}"
                 Title="Seleccione un Pluviometro"
                 FontSize="16"
                 BackgroundColor="Transparent"
                 IsEnabled="{Binding AreFieldsLocked, Converter={StaticResource InvertedBoolConverter}}" />
                            </Frame>
                        </StackLayout>


                        <!-- Horas -->
                        <StackLayout>
                            <Label Text="Horas" FontSize="14" TextColor="{StaticResource Gray600}" />
                            <Frame BackgroundColor="{StaticResource Gray100}" CornerRadius="10" Padding="0" HasShadow="False">
                                <Picker ItemsSource="{Binding TipoEntrada}"
                                    SelectedItem="{Binding SelectedTipoEntrada}"
                                    Title="Horas"
                                    FontSize="16"
                                    BackgroundColor="Transparent"
                                    IsEnabled="{Binding AreFieldsLocked, Converter={StaticResource InvertedBoolConverter}}" />
                            </Frame>

                        </StackLayout>

                        <!-- Buttons -->
                        <Grid ColumnDefinitions="*,*,*" ColumnSpacing="10">

                            <Button Grid.Column="1"
                              Text="Añadir"
                              Command="{Binding SaveValeCommand}"
                              BackgroundColor="{StaticResource Primary}"
                              TextColor="White"
                              CornerRadius="10"    
                              FontSize="18" />
                        </Grid>

                        <!-- Debug button for testing recipes -->
                        <Button Text="🔍 Debug Recetas con Artículos"
                          Command="{Binding DebugRecetasConArticulosCommand}"
                          BackgroundColor="{StaticResource Gray600}"
                          TextColor="White"
                          CornerRadius="10"
                          FontSize="14"
                          Margin="0,10,0,0" />
                    </StackLayout>
                </Frame>

            </StackLayout>
        </ScrollView>
        <!-- Loading Indicator -->
        <ActivityIndicator Grid.Row="1"
                          IsRunning="{Binding IsBusy}" 
                          IsVisible="{Binding IsBusy}"
                          Color="{DynamicResource Primary}"
                          VerticalOptions="Center"
                          HorizontalOptions="Center" />

    </Grid>

</ContentPage>
