<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="sys21_campos_zukarmex.Views.StatusPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:sys21_campos_zukarmex.ViewModels"
             xmlns:models="clr-namespace:sys21_campos_zukarmex.Models"
             x:DataType="viewmodels:StatusViewModel"
             Title="{Binding Title}"
             BackgroundColor="{DynamicResource Gray100}">

    <Grid RowDefinitions="Auto,*">

        <!-- Header with Statistics -->
        <Frame Grid.Row="0" BackgroundColor="White" CornerRadius="0" Padding="20" HasShadow="True" Margin="0,0,0,10">
            <StackLayout Spacing="15">

                <Label Text="Vales Pendientes" 
                       FontSize="22" 
                       FontAttributes="Bold"
                       TextColor="{DynamicResource Primary}"
                       HorizontalOptions="Center" />

                <Grid ColumnDefinitions="*,*,*" ColumnSpacing="10">

                    <!-- Total Pending -->
                    <StackLayout Grid.Column="0" HorizontalOptions="Center">
                        <Label Text="{Binding TotalPending}" 
                               FontSize="24" 
                               FontAttributes="Bold"
                               TextColor="Orange"
                               HorizontalOptions="Center" />
                        <Label Text="Pendientes" 
                               FontSize="12" 
                               TextColor="{DynamicResource Gray600}"
                               HorizontalOptions="Center" />
                    </StackLayout>

                    <!-- Total Synced -->
                    <StackLayout Grid.Column="1" HorizontalOptions="Center">
                        <Label Text="{Binding TotalSynced}" 
                               FontSize="24" 
                               FontAttributes="Bold"
                               TextColor="Green"
                               HorizontalOptions="Center" />
                        <Label Text="Sincronizados" 
                               FontSize="12" 
                               TextColor="{DynamicResource Gray600}"
                               HorizontalOptions="Center" />
                    </StackLayout>

                    <!-- Last Update -->
                    <StackLayout Grid.Column="2" HorizontalOptions="Center">
                        <Label Text="{Binding LastUpdateTime}" 
                               FontSize="24"
                               FontAttributes="Bold"
                               TextColor="{DynamicResource Primary}"
                               HorizontalOptions="Center" />
                        <Label Text="Ultima actualizacion" 
                               FontSize="12" 
                               TextColor="{DynamicResource Gray600}"
                               HorizontalOptions="Center" />
                    </StackLayout>

                </Grid>

                <!-- Refresh Button -->
                <Button Text="Actualizar Estado"
                        Command="{Binding SyncPendingValesCommand}"
                        BackgroundColor="{DynamicResource Info}"
                        TextColor="White"
                        CornerRadius="10"
                        HeightRequest="40"
                        FontSize="14" />

            </StackLayout>
        </Frame>

        <!-- Pending Vales List -->
        <RefreshView Grid.Row="1" IsRefreshing="{Binding IsRefreshing}" Command="{Binding LoadStatusCommand}">
            <CollectionView ItemsSource="{Binding PendingVales}" 
                           BackgroundColor="Transparent"
                           Margin="10,0">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Salida">
                        <Frame BackgroundColor="White" 
                               CornerRadius="10" 
                               Padding="15" 
                               Margin="10,5"
                               HasShadow="True">
                            <Grid ColumnDefinitions="*, Auto" Padding="15">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>

                                <StackLayout Grid.Row="0" Grid.Column="0" Spacing="2">
                                    <Label Text="{Binding Id, StringFormat='Temporal id-Vale #{0}'}"
                                           FontSize="18"
                                           FontAttributes="Bold"
                                           TextColor="{DynamicResource Primary}" />
                                    <Label Text="{Binding Concepto}"
                                           FontSize="16"
                                           TextColor="{DynamicResource Gray700}"
                                           LineBreakMode="TailTruncation" />
                                </StackLayout>

                                <StackLayout Grid.Row="1" Grid.Column="0" Spacing="2" Margin="0,10,0,0">
                                    <Label Text="{Binding Fecha, StringFormat='Fecha: {0:dd/MM/yyyy}'}"
                                           FontSize="12"
                                           TextColor="{DynamicResource Gray600}" />
                                    <Label Text="{Binding Usuario, StringFormat='Usuario: {0}'}"
                                           FontSize="12"
                                           TextColor="{DynamicResource Gray600}" />
                                </StackLayout>

                                <StackLayout Grid.Row="0" Grid.RowSpan="2" Grid.Column="1" 
                                             Spacing="8" 
                                             VerticalOptions="Center" 
                                             HorizontalOptions="End">

                                    <Frame BackgroundColor="{Binding Status, Converter={StaticResource StatusToColorConverter}}"
                                           CornerRadius="15"
                                           Padding="8"
                                           HasShadow="False">

                                        <Label Text="{Binding StatusDisplay}" FontSize="12"
                                            TextColor="White"
                                            FontAttributes="Bold"/>
                                    </Frame>

                                    <Button Text="Ver"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:StatusViewModel}}, Path=ViewValeDetailsCommand}"
                                            CommandParameter="{Binding .}"
                                            BackgroundColor="{DynamicResource Primary}"
                                            TextColor="White"
                                            CornerRadius="8"
                                            FontSize="12"
                                            WidthRequest="60"
                                            HeightRequest="35" />
                                </StackLayout>

                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
                <CollectionView.EmptyView>
                    <StackLayout HorizontalOptions="Center" VerticalOptions="Center" Padding="50">
                        <Label Text="OK" 
                               FontSize="48" 
                               FontAttributes="Bold"
                               TextColor="Green"
                               HorizontalOptions="Center" />
                        <Label Text="No hay vales pendientes" 
                               FontSize="18" 
                               TextColor="{DynamicResource Gray600}"
                               HorizontalOptions="Center" />
                        <Label Text="Todos los vales estan sincronizados" 
                               FontSize="14" 
                               TextColor="{DynamicResource Gray500}"
                               HorizontalOptions="Center" />
                    </StackLayout>
                </CollectionView.EmptyView>
            </CollectionView>
        </RefreshView>

        <!-- Loading Indicator -->
        <ActivityIndicator Grid.Row="1"
                          IsRunning="{Binding IsBusy}" 
                          IsVisible="{Binding IsBusy}"
                          Color="{DynamicResource Primary}"
                          VerticalOptions="Center"
                          HorizontalOptions="Center" />
    </Grid>
</ContentPage>